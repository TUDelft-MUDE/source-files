on:
  push:
    branches:
      - '**'

permissions:
  contents: write

jobs:
  detect-and-update:
    name: Detect binary files and update .gitattributes
    runs-on: ubuntu-latest
    steps:
      - name: Exit when run by GitHub Actions bot
        if: ${{ github.actor == 'github-actions[bot]' }}
        run: |
          echo "Triggered by github-actions[bot] â€” exiting to avoid a loop."
      - name: Checkout repository
        if: ${{ github.actor != 'github-actions[bot]' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      - name: Configure git user
        if: ${{ github.actor != 'github-actions[bot]' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Install Git LFS
        if: ${{ github.actor != 'github-actions[bot]' }}
        run: |
          git lfs install
      - name: Detect binary file types under file/ and build new .gitattributes
        if: ${{ github.actor != 'github-actions[bot]' }}
        run: |
          set -euo pipefail
          REPO_ROOT="$(pwd)"
          EXISTING="${REPO_ROOT}/.gitattributes"
          TMP_BASE="$(mktemp)"
          TMP_EXTS="$(mktemp)"
          # Preserve existing .gitattributes but remove LFS pattern lines
          if [ -f "${EXISTING}" ]; then
            grep -vE 'filter=lfs diff=lfs merge=lfs' "${EXISTING}" > "${TMP_BASE}" || true
          else
            touch "${TMP_BASE}"
          fi
          # Collect extensions of binary files under "file/"
          : > "${TMP_EXTS}"
          git ls-files -z -- file | while IFS= read -r -d '' f; do
            if [ -f "$f" ]; then
              # Use git's native binary detection via diff --numstat
              # Binary files show "- - filename" in numstat output
              if git diff --numstat 4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD -- "$f" | grep -q "^-[[:space:]]*-[[:space:]]"; then
                # Extract extension (everything after last dot, or empty if no dot)
                ext="${f##*.}"
                if [ "$ext" != "$f" ] && [ -n "$ext" ]; then
                  echo "$ext"
                fi
              fi
            fi
          done | sort -u > "${TMP_EXTS}" || true
          # Build new .gitattributes with extension patterns
          cat "${TMP_BASE}" > "${REPO_ROOT}/.gitattributes.new"
          if [ -s "${TMP_EXTS}" ]; then
            echo "" >> "${REPO_ROOT}/.gitattributes.new"
            echo "# Binary file types tracked with LFS" >> "${REPO_ROOT}/.gitattributes.new"
            while IFS= read -r ext; do
              printf "*.%s filter=lfs diff=lfs merge=lfs -text\n" "$ext"
            done < "${TMP_EXTS}" >> "${REPO_ROOT}/.gitattributes.new"
          fi
          # Remove duplicate lines while preserving first occurrence
          awk '!seen[$0]++' "${REPO_ROOT}/.gitattributes.new" > "${REPO_ROOT}/.gitattributes.final"
          mv "${REPO_ROOT}/.gitattributes.final" "${REPO_ROOT}/.gitattributes"
          # Clean up temp files
          rm -f "${TMP_BASE}" "${TMP_EXTS}" "${REPO_ROOT}/.gitattributes.new"
          echo "Computed .gitattributes (preview):"
          git --no-pager diff -- .gitattributes || true
      - name: Commit and push updated .gitattributes if changed
        if: ${{ github.actor != 'github-actions[bot]' }}
        run: |
          if git status --porcelain -- .gitattributes | grep -q .; then
            git add .gitattributes
            git commit -m "chore: update .gitattributes for binary file types (automated)"
            git push
          else
            echo "No .gitattributes changes to commit."
          fi
      - name: Re-add files as LFS
        if: ${{ github.actor != 'github-actions[bot]' }}
        run: |
          set -euo pipefail
          # Find files that should be in LFS according to .gitattributes
          # Use a temp file to collect the list
          TMP_FILES=$(mktemp)
          git ls-files -z -- file | while IFS= read -r -d '' f; do
            if [ -f "$f" ]; then
              # Use git's native binary detection via diff --numstat
              # Binary files show "- - filename" in numstat output
              if git diff --numstat 4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD -- "$f" | grep -q "^-[[:space:]]*-[[:space:]]"; then
                printf "%s\0" "$f"
              fi
            fi
          done > "${TMP_FILES}"
          
          if [ -s "${TMP_FILES}" ]; then
            echo "Files to migrate to LFS:"
            cat "${TMP_FILES}" | xargs -0 printf "%s\n"
            
            # Remove files from Git cache and re-add them
            cat "${TMP_FILES}" | xargs -0 git rm --cached --
            cat "${TMP_FILES}" | xargs -0 git add --
            
            rm -f "${TMP_FILES}"
            
            if git status --porcelain | grep -q .; then
              git commit -m "chore: migrate binary files to LFS (automated)"
              git push
            else
              echo "Files already in LFS format."
            fi
          else
            echo "No binary files to migrate to LFS."
            rm -f "${TMP_FILES}"
          fi